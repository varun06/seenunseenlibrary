# Data Processing Scripts

This directory contains scripts for processing and maintaining book data.

## ⚠️ Important Note

**CSV Processing is Optional**: The app works directly with `public/data/books.json`. You only need to run CSV processing scripts if you need to regenerate the data from CSV files.

## Available Scripts

### Essential Scripts (Work with JSON directly)

#### `fetch_covers.js`
Fetches book cover images from Open Library and Amazon.

**Usage**:
```bash
npm run fetch-covers
```

**What it does**:
- Reads from `public/data/books.json`
- Fetches covers from Open Library first, then Amazon
- Saves images to `public/images/covers/`
- Updates `books.json` with cover paths

---

#### `extract_colors.js`
Extracts dominant colors from book cover images.

**Usage**:
```bash
npm run extract-colors
```

**What it does**:
- Reads from `public/data/books.json`
- Analyzes cover images to extract dominant colors
- Calculates contrasting text colors
- Updates `books.json` with color information

---

#### `deduplicate_books.js`
Removes duplicate books from the dataset.

**Usage**:
```bash
npm run deduplicate
```

**What it does**:
- Reads from `public/data/books.json`
- Identifies duplicates by ID and normalized title
- Merges episodes from duplicate entries
- Writes deduplicated data back to `books.json`

---

#### `add_episode_books.js`
Adds new episodes to existing books.

**Usage**:
```bash
npm run add-episode
```

**What it does**:
- Reads from `public/data/books.json`
- Allows adding new episodes to existing books
- Updates episode counts
- Maintains data integrity

**Note**: See `ADD_EPISODE_README.md` for detailed usage.

---

### Optional Scripts (CSV Processing - Only for Regeneration)

#### `process_books_data.js`
Converts CSV files to JSON format. **Only needed if regenerating data from CSV**.

**Usage** (if you have CSV files):
```bash
# Option 1: Environment variables
UNIQUE_CSV=./path/to/unique.csv EXPANDED_CSV=./path/to/expanded.csv npm run _process-data

# Option 2: Command line arguments
node scripts/process_books_data.js ./path/to/unique.csv ./path/to/expanded.csv

# Option 3: Update paths in script and run
npm run _process-data
```

**What it does**:
- Reads unique books CSV and expanded episodes CSV
- Merges data into single JSON structure
- Generates IDs, calculates spine widths
- Writes to `public/data/books.json`

**When to use**:
- Initial data setup from CSV files
- Regenerating data after CSV updates
- Migrating from CSV to JSON format

**Note**: This script requires CSV files. If you already have `books.json`, you don't need this script.

---

## Data Flow

### Normal Operation (Using Existing JSON)
```
books.json → App (reads directly)
```

### Regeneration from CSV (Optional)
```
CSV files → process_books_data.js → books.json → App
```

### Data Enhancement (After JSON exists)
```
books.json → fetch_covers.js → books.json (with covers)
books.json → extract_colors.js → books.json (with colors)
books.json → deduplicate_books.js → books.json (deduplicated)
books.json → add_episode_books.js → books.json (with new episodes)
```

## File Dependencies

### Required Files:
- `public/data/books.json` - Main data file (required for app to work)

### Optional Files:
- CSV files - Only needed for `process_books_data.js`

### Generated Files:
- `public/images/covers/*.jpg` - Book cover images (generated by `fetch_covers.js`)

## Script Dependencies

### Node.js Packages:
- `csv-parser` - Only used by `process_books_data.js` (optional)
- `canvas` - Used by `extract_colors.js` (optional dependency)
- `sharp` - Used by image processing (optional)

### Installation:
```bash
# Install all dependencies (includes optional ones)
npm install

# Or install only essential dependencies (if not using CSV/colors)
npm install --no-optional
```

## Common Workflows

### Setting Up New Data from CSV:
```bash
# 1. Process CSV files to JSON
UNIQUE_CSV=./unique.csv EXPANDED_CSV=./expanded.csv npm run _process-data

# 2. Fetch book covers
npm run fetch-covers

# 3. Extract colors
npm run extract-colors
```

### Updating Existing Data:
```bash
# 1. Deduplicate (if needed)
npm run deduplicate

# 2. Add new episodes (if needed)
npm run add-episode

# 3. Fetch missing covers
npm run fetch-covers

# 4. Update colors
npm run extract-colors
```

### Maintenance:
```bash
# Remove duplicates
npm run deduplicate

# Update covers
npm run fetch-covers
```

## Troubleshooting

### "CSV file not found" error
- **Cause**: Running `_process-data` without CSV files
- **Solution**: You don't need CSV files if `books.json` already exists. Skip this script.

### "books.json does not exist" error
- **Cause**: Missing data file
- **Solution**: Either provide CSV files to generate JSON, or ensure `books.json` exists in `public/data/`

### Missing covers
- **Cause**: Covers not fetched yet
- **Solution**: Run `npm run fetch-covers` to fetch missing covers

### Color extraction fails
- **Cause**: Missing `canvas` package or cover images
- **Solution**: Install `canvas` with `npm install` (it's an optional dependency)
